/*
 * vmnetfs - virtual machine network execution virtual filesystem
 *
 * Copyright (C) 2006-2012 Carnegie Mellon University
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of version 2 of the GNU General Public License as published
 * by the Free Software Foundation.  A copy of the GNU General Public License
 * should have been distributed along with this program in the file
 * COPYING.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * for more details.
 */

#include <sys/types.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <signal.h>
#include <errno.h>
#include "vmnetfs-private.h"

#define IMAGE_ARG_COUNT 7

static void _image_free(struct vmnetfs_image *img)
{
    _vmnetfs_stream_group_free(img->io_stream);
    _vmnetfs_stat_free(img->bytes_read);
    _vmnetfs_stat_free(img->bytes_written);
    _vmnetfs_stat_free(img->chunk_fetches);
    _vmnetfs_stat_free(img->chunk_dirties);
    g_free(img->url);
    g_free(img->username);
    g_free(img->password);
    g_free(img->total_overlay_chunks);
    g_slice_free(struct vmnetfs_image, img);
}

static void image_free(struct vmnetfs_image *img)
{
    if (img == NULL) {
        return;
    }
    _vmnetfs_io_destroy(img);
    _image_free(img);
}

static uint64_t parse_uint(const char *str, GError **err)
{
    char *endptr;
    uint64_t ret;

    ret = g_ascii_strtoull(str, &endptr, 10);
    if (*str == 0 || *endptr != 0) {
        g_set_error(err, VMNETFS_CONFIG_ERROR,
                VMNETFS_CONFIG_ERROR_INVALID_ARGUMENT,
                "Invalid integer argument: %s", str);
        return 0;
    }
    return ret;
}

static char *read_line(GIOChannel *chan, GError **err)
{
    char *buf;
    gsize terminator;

    switch (g_io_channel_read_line(chan, &buf, NULL, &terminator, err)) {
    case G_IO_STATUS_ERROR:
        return NULL;
    case G_IO_STATUS_NORMAL:
        buf[terminator] = 0;
        return buf;
    case G_IO_STATUS_EOF:
        g_set_error(err, G_IO_CHANNEL_ERROR, G_IO_CHANNEL_ERROR_IO,
                "Unexpected EOF");
        return NULL;
    case G_IO_STATUS_AGAIN:
        g_set_error(err, G_IO_CHANNEL_ERROR, G_IO_CHANNEL_ERROR_IO,
                "Unexpected EAGAIN");
        return NULL;
    default:
        g_assert_not_reached();
    }
}

static char **get_arguments(GIOChannel *chan, GError **err)
{
    uint64_t n;
    uint64_t count;
    char *str;
    GPtrArray *args;
    GError *my_err = NULL;

    /* Get argument count */
    str = read_line(chan, err);
    if (str == NULL) {
        return NULL;
    }
    count = parse_uint(str, &my_err);
    if (my_err) {
        g_propagate_error(err, my_err);
        return NULL;
    }

    /* Get arguments */
    args = g_ptr_array_new_with_free_func(g_free);
    for (n = 0; n < count; n++) {
        str = read_line(chan, err);
        if (str == NULL) {
            g_ptr_array_free(args, TRUE);
            return NULL;
        }
        g_ptr_array_add(args, str);
    }
    g_ptr_array_add(args, NULL);
    return (char **) g_ptr_array_free(args, FALSE);
}

static struct vmnetfs_image *image_new(char **argv, const char *username,
        const char *password, GError **err)
{
    struct vmnetfs_image *img;
    int arg = 0;
    GError *my_err = NULL;

    const char *url = argv[arg++];
    const char *base_path = argv[arg++];
    const char *overlay_path = argv[arg++];
    const char *overlay_info = argv[arg++];
    const uint64_t size = parse_uint(argv[arg++], &my_err);
    if (my_err) {
        g_propagate_error(err, my_err);
        return NULL;
    }
    const uint64_t segment_size = parse_uint(argv[arg++], &my_err);
    if (my_err) {
        g_propagate_error(err, my_err);
        return NULL;
    }
    const uint32_t chunk_size = parse_uint(argv[arg++], &my_err);
    if (my_err) {
        g_propagate_error(err, my_err);
        return NULL;
    }

    const int base_fd = open(base_path, O_RDONLY);
    if (base_fd < 0){
        g_set_error(err, VMNETFS_CONFIG_ERROR,
                VMNETFS_CONFIG_ERROR_INVALID_ARGUMENT,
                "Invalid path for base image: %s", base_path);
        return NULL;
    }
    int overlay_fd = -1;
    if (strlen(overlay_path) != 0){
        overlay_fd = open(overlay_path, O_RDONLY);
        if (overlay_fd < 0){
        	g_set_error(err, VMNETFS_CONFIG_ERROR,
        			VMNETFS_CONFIG_ERROR_INVALID_ARGUMENT,
        			"Invalid path for overlay image: %s", overlay_path);
        	return NULL;
        }
    }

    img = g_slice_new0(struct vmnetfs_image);
    img->url = g_strdup(url);
    img->username = g_strdup(username);
    img->password = g_strdup(password);
    img->total_overlay_chunks = g_strdup(overlay_info);
    img->initial_size = size;
    img->segment_size = segment_size;
    img->chunk_size = chunk_size;
    img->base_fd = base_fd;
    img->overlay_fd = overlay_fd;

    img->io_stream = _vmnetfs_stream_group_new(NULL, NULL);
    img->bytes_read = _vmnetfs_stat_new();
    img->bytes_written = _vmnetfs_stat_new();
    img->chunk_fetches = _vmnetfs_stat_new();
    img->chunk_dirties = _vmnetfs_stat_new();

    if (!_vmnetfs_io_init(img, err)) {
        _image_free(img);
        return NULL;
    }

    return img;
}

static void image_close(struct vmnetfs_image *img)
{
    _vmnetfs_io_close(img);
    _vmnetfs_stat_close(img->bytes_read);
    _vmnetfs_stat_close(img->bytes_written);
    _vmnetfs_stat_close(img->chunk_fetches);
    _vmnetfs_stat_close(img->chunk_dirties);
    _vmnetfs_stream_group_close(img->io_stream);
}

static void *glib_loop_thread(void *data)
{
    struct vmnetfs *fs = data;

    fs->glib_loop = g_main_loop_new(NULL, TRUE);
    g_main_loop_run(fs->glib_loop);
    g_main_loop_unref(fs->glib_loop);
    fs->glib_loop = NULL;
    return NULL;
}

static gboolean read_stdin(GIOChannel *source G_GNUC_UNUSED,
        GIOCondition cond G_GNUC_UNUSED, void *data)
{
    struct vmnetfs *fs = data;
    char buf[16];
    ssize_t ret;

    /* See if stdin has been closed. */
    do {
        ret = read(0, buf, sizeof(buf));
        if (ret == -1 && (errno == EAGAIN || errno == EINTR)) {
            return TRUE;
        }
    } while (ret > 0);

    /* Stop allowing blocking reads on streams (to prevent unmount from
       blocking forever) and lazy-unmount the filesystem.  For complete
       correctness, this should disallow new image opens, wait for existing
       image fds to close, disallow new stream opens and blocking reads,
       then lazy unmount. */
    image_close(fs->disk);
    if (fs->memory != NULL) {
        image_close(fs->memory);
    }
    _vmnetfs_fuse_terminate(fs->fuse);
    return FALSE;
}

static gboolean shutdown_callback(void *data)
{
    struct vmnetfs *fs = data;

    g_main_loop_quit(fs->glib_loop);
    return FALSE;
}

static void child(FILE *pipe)
{
    struct vmnetfs *fs;
    GThread *loop_thread = NULL;
    GIOChannel *chan;
    GIOChannel *chan_out;
    GIOFlags flags;
    int argc;
    char **argv;
    int arg = 0;
    int images;
    char *username;
    char *password;
    GError *err = NULL;

    /* Initialize */
    if (!g_thread_supported()) {
        g_thread_init(NULL);
    }
    if (!_vmnetfs_transport_init()) {
        fprintf(pipe, "Could not initialize transport\n");
        fclose(pipe);
        return;
    }

    /* Read arguments */
    chan = g_io_channel_unix_new(0);
    chan_out = g_io_channel_unix_new(1);
    argv = get_arguments(chan, &err);
    /*
    // krha
    GPtrArray *args = g_ptr_array_new_with_free_func(g_free);
    g_ptr_array_add(args, "");					// user id
    g_ptr_array_add(args, "");					// password
    g_ptr_array_add(args, "http://cloudlet.krha.kr/ubuntu-11/");					// dummy url
    g_ptr_array_add(args, "/home/krha/cloudlet/src/vmnetx/custom/ubuntu-11.raw");	// base path
    g_ptr_array_add(args, "/home/krha/cloudlet/src/vmnetx/custom/disk-resume");					// overlay path
	// overlay initialized info, list of (chunk #:is_avalaible)
    g_ptr_array_add(args, "256:1,257:1,513:1,514:1,515:1,517:1,518:1,519:1,520:1,521:1,529:1,530:1,531:1,545:1,546:1,547:1,551:1,556:1,557:1,558:1,559:1,560:1,561:1,562:1,563:1,564:1,566:1,567:1,571:1,573:1,574:1,577:1,578:1,579:1,580:1,582:1,583:1,585:1,587:1,588:1,589:1,590:1,591:1,596:1,599:1,600:1,601:1,610:1,612:1,614:1,616:1,617:1,618:1,619:1,620:1,628:1,633:1,747:1,1403:1,1404:1,1405:1,1406:1,1407:1,1408:1,1409:1,1464:1,1480:1,1505:1,1511:1,1512:1,1519:1,1526:1,1537:1,1542:1,1569:1,1570:1,1576:1,1582:1,1608:1,1698:1,1838:1,1849:1,1893:1,1894:1,1895:1,1899:1,1901:1,1902:1,1903:1,1906:1,1907:1,1908:1,8748:1,8750:1,8770:1,8785:1,11031:1,11033:1,11034:1,12470:1,12492:1,12493:1,12494:1,12495:1,12496:1,12497:1,12498:1,12499:1,33369:1,33496:1,33497:1,33498:1,33499:1,33500:1,33501:1,33502:1,33503:1,33504:1,33505:1,33506:1,33507:1,33508:1,33509:1,33510:1,33511:1,33512:1,33513:1,33514:1,33515:1,33516:1,33517:1,33518:1,33519:1,33520:1,33521:1,33522:1,33523:1,33524:1,33525:1,33526:1,33527:1,33656:1,33711:1,33724:1,33725:1,33726:1,34045:1,37120:1,38144:1,50432:1,230374:1,459008:1,459009:1,459010:1,459011:1,459012:1,459013:1,459014:1,459015:1,459016:1,459017:1,459018:1,459019:1,459020:1,459021:1,459022:1,459023:1,459024:1,459025:1,459026:1,459027:1,459028:1,459029:1,459030:1,459031:1,459032:1,459033:1,459034:1,459035:1,459036:1,459037:1,459038:1,459039:1,459040:1,459041:1,459042:1,459043:1,459044:1,459045:1,459046:1,459047:1,459048:1,459049:1,459050:1,459051:1,459052:1,459053:1,459054:1,459055:1,459056:1,459057:1,459058:1,459059:1,459060:1,459061:1,459062:1,459063:1,459064:1,459065:1,459066:1,459067:1,459068:1,459069:1,459070:1,459071:1,459072:1,459073:1,459074:1,459075:1,459076:1,459077:1,459078:1,459079:1,459080:1,459081:1,459082:1,459083:1,459084:1,459085:1,459086:1,459087:1,459088:1,459089:1,459090:1,459091:1,459092:1,459093:1,459094:1,459095:1,459096:1,459097:1,459098:1,459099:1,459100:1,459101:1,459102:1,459103:1,459104:1,459105:1,459106:1,459107:1,459108:1,459109:1,459110:1,459111:1,459112:1,459113:1,459114:1,459115:1,459116:1,459117:1,459118:1,459119:1,459120:1,459121:1,459122:1,459123:1,459124:1,459125:1,459126:1,459127:1,459128:1,459129:1,459130:1,459131:1,459132:1,459133:1,459134:1,459135:1,459136:1,459137:1,459138:1,459139:1,459140:1,459141:1,459142:1,459143:1,459144:1,459145:1,459146:1,459147:1,459148:1,459149:1,459150:1,459151:1,459152:1,459153:1,459154:1,459155:1,459156:1,459157:1,459158:1,459159:1,459160:1,459161:1,459162:1,459163:1,459164:1,459165:1,459166:1,459167:1,459168:1,459169:1,459170:1,459171:1,459172:1,459173:1,459174:1,459175:1,459176:1,459177:1,459178:1,459179:1,459180:1,459181:1,459182:1,459183:1,459184:1,459185:1,459186:1,459187:1,459188:1,459189:1,459190:1,459191:1,459192:1,459193:1,459194:1,459195:1,459196:1,459197:1,459198:1,459199:1,459200:1,459201:1,459202:1,459203:1,459204:1,459205:1,459206:1,459207:1,459208:1,459209:1,459210:1,459211:1,459212:1,459213:1,459214:1,459215:1,459216:1,459217:1,459218:1,459219:1,459220:1,459221:1,459222:1,459223:1,459224:1,459225:1,459226:1,459227:1,459228:1,459229:1,459230:1,459231:1,459232:1,459233:1,459234:1,459235:1,459236:1,459237:1,459238:1,459239:1,459240:1,459241:1,459242:1,459243:1,459244:1,459245:1,459246:1,459247:1,459248:1,459249:1,459250:1,459251:1,459252:1,459253:1,459254:1,459255:1,459256:1,459257:1,459258:1,459259:1,459260:1,459261:1,459262:1,459263:1,459264:1,459265:1,459266:1,459267:1,459268:1,459269:1,459270:1,459271:1,459272:1,459273:1,459274:1,459275:1,459276:1,459277:1,459278:1,459279:1,459280:1,459281:1,459282:1,459283:1,459284:1,459285:1,459286:1,459287:1,459288:1,459289:1,459290:1,459291:1,459292:1,459293:1,459294:1,459295:1,459296:1,459297:1,459298:1,459299:1,459300:1,459301:1,459302:1,459303:1,459304:1,459305:1,459306:1,459307:1,459308:1,459309:1,459310:1,459311:1,459312:1,459313:1,459314:1,459315:1,459316:1,459317:1,459318:1,459319:1,459320:1,459321:1,459322:1,459323:1,459324:1,459325:1,459326:1,459327:1,459328:1,459329:1,459330:1,459331:1,459332:1,459333:1,459334:1,459335:1,459336:1,459337:1,459338:1,459339:1,459340:1,459341:1,459342:1,459343:1,459344:1,459345:1,459346:1,459347:1,459348:1,459349:1,459350:1,459351:1,459352:1,459353:1,459354:1,459355:1,459356:1,459357:1,459358:1,459359:1,459360:1,459361:1,459362:1,459363:1,459364:1,459365:1,459366:1,459367:1,459368:1,459369:1,459370:1,459371:1,459372:1,459373:1,459374:1,459375:1,459376:1,459377:1,459378:1,459379:1,459380:1,459381:1,459382:1,459383:1,459384:1,459385:1,459386:1,459387:1,459388:1,459389:1,459390:1,459391:1,459392:1,459393:1,459394:1,459395:1,459396:1,459397:1,459398:1,459399:1,459400:1,459401:1,459402:1,459403:1,459404:1,459405:1,459406:1,459407:1,459408:1,459409:1,459410:1,459411:1,459412:1,459413:1,459414:1,459415:1,459416:1,459417:1,459418:1,459419:1,459420:1,459421:1,459422:1,459423:1,459424:1,459425:1,459426:1,459427:1,459428:1,459429:1,459430:1,459431:1,459432:1,459433:1,459434:1,459435:1,459436:1,459437:1,459438:1,459439:1,459440:1,459441:1,459442:1,459443:1,459444:1,459445:1,459446:1,459447:1,459448:1,459449:1,459450:1,459451:1,459452:1,459453:1,459454:1,459455:1,459456:1,459457:1,459458:1,459459:1,459460:1,459461:1,459462:1,459463:1,459464:1,459465:1,459466:1,459467:1,459468:1,459469:1,459470:1,459471:1,459472:1,459473:1,459474:1,459475:1,459476:1,459477:1,459478:1,459479:1,459480:1,459481:1,459482:1,459483:1,459484:1,459485:1,459486:1,459487:1,459488:1,459489:1,459490:1,459491:1,459492:1,459493:1,459494:1,459495:1,459496:1,459497:1,459498:1,459499:1,459500:1,459501:1,459502:1,459503:1,459504:1,459505:1,459506:1,459507:1,524545:1,524546:1,524547:1,524560:1,524576:1,524577:1,524578:1,524580:1,524581:1,524582:1,524584:1,524585:1,524586:1,524587:1,524588:1,524591:1,524592:1,524601:1,524604:1,524605:1,524606:1,524607:1,524608:1,524614:1,524615:1,524619:1,524621:1,524622:1,524623:1,524626:1,524629:1,524630:1,524631:1,524632:1,524633:1,524634:1,524635:1,524636:1,524637:1,524639:1,524640:1,524641:1,524642:1,524643:1,524645:1,524647:1,524658:1,524659:1,524661:1,524662:1,524663:1,524665:1,524667:1,524670:1,524673:1,524674:1,524675:1,524676:1,524677:1,524678:1,524679:1,524680:1,524681:1,524682:1,524689:1,524691:1,524692:1,524693:1,524694:1,524695:1,524696:1,524697:1,524698:1,524701:1,524702:1,524703:1,524706:1,524707:1,524708:1,524709:1,524710:1,524712:1,524714:1,524740:1,524741:1,524742:1,524743:1,524745:1,524759:1,524760:1,524764:1,524768:1,524769:1,524771:1,524772:1,524773:1,524782:1,524783:1,524784:1,524785:1,524824:1,524837:1,524846:1,524847:1,524849:1,524854:1,524865:1,524869:1,524870:1,524871:1,524888:1,524890:1,524891:1,524896:1,524898:1,524902:1,524903:1,524904:1,524905:1,524908:1,524935:1,524936:1,524938:1,524945:1,524946:1,524948:1,524951:1,524952:1,524953:1,524961:1,524962:1,524963:1,524967:1,524968:1,524969:1,524970:1,524974:1,524976:1,524981:1,524984:1,524993:1,524994:1,525003:1,525008:1,525014:1,525029:1,525030:1,525031:1,525032:1,525033:1,525034:1,525036:1,525040:1,525044:1,525048:1,525050:1,525051:1,525053:1,525054:1,525055:1,525058:1,525059:1,525060:1,525088:1,525089:1,525090:1,525096:1,525097:1,525099:1,525100:1,525101:1,525102:1,525103:1,525163:1,525165:1,525170:1,525184:1,525194:1,525195:1,525196:1,525199:1,525200:1,525202:1,525203:1,525204:1,525205:1,525206:1,525207:1,525208:1,525209:1,525210:1,525211:1,525212:1,525248:1,525252:1,525257:1,526064:1,526065:1,526066:1,526067:1,526097:1,526100:1,526101:1,526107:1,526110:1,526111:1,526113:1,526114:1,526115:1,526182:1,526183:1,526208:1,526209:1,526219:1,526221:1,526222:1,526223:1,526224:1,526226:1,526227:1,526229:1,526231:1,526232:1,526233:1,526234:1,526235:1,526236:1,526237:1,526238:1,526239:1,526240:1,526241:1,526242:1,526243:1,526247:1,526251:1,526264:1,526273:1,526280:1,526309:1,526310:1,526311:1,526313:1,526315:1,526316:1,526317:1,526319:1,526326:1,526327:1,526328:1,526329:1,526330:1,526349:1,526350:1,526352:1,526353:1,526356:1,526359:1,526361:1,526362:1,526366:1,526367:1,526369:1,526371:1,526372:1,526380:1,526383:1,526384:1,526391:1,526392:1,526406:1,526415:1,526435:1,526437:1,526438:1,526439:1,526440:1,526444:1,526445:1,526446:1,526447:1,526457:1,526466:1,526467:1,526468:1,526469:1,526470:1,526471:1,526472:1,526473:1,526474:1,526475:1,526476:1,526477:1,526489:1,526493:1,526494:1,526495:1,526500:1,526519:1,526520:1,526521:1,526522:1,526523:1,526525:1,526527:1,526528:1,526529:1,526531:1,526539:1,526540:1,526541:1,526553:1,526555:1,526556:1,526557:1,526558:1,526561:1,526562:1,526563:1,526564:1,526573:1,526574:1,526575:1,526576:1,526577:1,526578:1,526579:1,526580:1,526581:1,526585:1,526589:1,526590:1,526592:1,526607:1,526608:1,526611:1,532768:1,561752:1,561753:1,561756:1,561757:1,561758:1,563435:1,563436:1,563437:1,563438:1,563439:1,563518:1,563519:1,613829:1,613830:1,613831:1,613832:1,613833:1,613834:1,613835:1,613836:1,626191:1,639781:1,639782:1,639783:1,639784:1,639785:1,639786:1,639787:1,639788:1,639789:1,639790:1,639791:1,639792:1,639793:1,639794:1,639795:1,639796:1,639797:1,639798:1,639799:1,639800:1,639801:1,639802:1,639803:1,639804:1,639805:1,639806:1,639807:1,639808:1,639809:1,639810:1,639811:1,639812:1,639813:1,639814:1,639815:1,639816:1,639817:1,639818:1,639819:1,639820:1,639821:1,639822:1,639823:1,639824:1,639825:1,639826:1,639827:1,639828:1,639829:1,639830:1,639831:1,639832:1,639833:1,639834:1,639835:1,639836:1,639837:1,639838:1,639839:1,639840:1,639841:1,639842:1,639843:1,639844:1,639845:1,639846:1,639847:1,639848:1,639849:1,639850:1,639851:1,639852:1,639853:1,639854:1,639855:1,639856:1,639857:1,639858:1,639859:1,639860:1,639861:1,639862:1,639863:1,639864:1,639865:1,639866:1,639867:1,639868:1,639869:1,639870:1,639871:1,639872:1,639873:1,639874:1,639875:1,639876:1,639877:1,639878:1,639879:1,639880:1,639881:1,639882:1,639883:1,639884:1,639885:1,639886:1,639887:1,639888:1,639889:1,639890:1,639891:1,639892:1,639893:1,639894:1,639895:1,639896:1,639897:1,639898:1,639899:1,639900:1,639901:1,639902:1,639903:1,639904:1,639905:1,639906:1,639907:1,639908:1,639909:1,639910:1,639911:1,639912:1,639913:1,639914:1,639915:1,639916:1,639917:1,639918:1,639919:1,639920:1,639921:1,639922:1,639923:1,639924:1,639925:1,639926:1,639927:1,639928:1,639929:1,639930:1,639931:1,639932:1,639933:1,639934:1,639935:1,639936:1,639937:1,639938:1,639939:1,639940:1,639941:1,639942:1,639943:1,639944:1,639945:1,639946:1,639947:1,639948:1,639949:1,639950:1,639951:1,639952:1,639953:1,639954:1,639955:1,639956:1,639957:1,639958:1,639959:1,639960:1,639961:1,639962:1,639963:1,639964:1,639965:1,639966:1,639967:1,639968:1,639969:1,639970:1,639971:1,639972:1,639973:1,639974:1,639975:1,639976:1,639977:1,639978:1,639979:1,639980:1,639981:1,639982:1,639983:1,639984:1,639985:1,639986:1,639987:1,639988:1,639989:1,639990:1,639991:1,639992:1,639993:1,639994:1,639995:1,639996:1,639997:1,639998:1,639999:1,640000:1,640001:1,640002:1,640003:1,640004:1,640005:1,640006:1,640007:1,640008:1,640009:1,640010:1,640011:1,640012:1,640013:1,640014:1,640015:1,640016:1,640017:1,640018:1,640019:1,640020:1,640021:1,640022:1,640023:1,640024:1,640025:1,640026:1,640027:1,640028:1,640029:1,640030:1,640031:1,640032:1,640033:1,640034:1,640035:1,640036:1,640037:1,640038:1,640039:1,640040:1,640041:1,640042:1,640043:1,640044:1,640045:1,640046:1,640047:1,640048:1,640049:1,640050:1,640051:1,640052:1,640053:1,640054:1,640055:1,640056:1,640057:1,640058:1,640059:1,640060:1,640061:1,640062:1,640063:1,640064:1,640065:1,640066:1,640067:1,640068:1,640069:1,640070:1,640071:1,640072:1,640073:1,640074:1,640075:1,640076:1,640077:1,640078:1,640079:1,640080:1,640081:1,640082:1,640083:1,640084:1,640085:1,640086:1,640087:1,640088:1,640089:1,640090:1,640091:1,640092:1,640093:1,640094:1,640095:1,640096:1,640097:1,640098:1,640099:1,640100:1,640101:1,640102:1,640103:1,640104:1,640105:1,640106:1,640107:1,640108:1,640109:1,640110:1,640111:1,640112:1,640113:1,640114:1,640115:1,640116:1,640117:1,640118:1,640119:1,640120:1,640121:1,640122:1,640123:1,640124:1,640125:1,640126:1,640127:1,640128:1,640129:1,640130:1,640131:1,640132:1,640133:1,640134:1,640135:1,640136:1,640137:1,640138:1,640139:1,640140:1,640141:1,640142:1,640143:1,640144:1,640145:1,640146:1,640147:1,640148:1,640149:1,640150:1,640151:1,640152:1,640153:1,640154:1,640155:1,640156:1,640157:1,640158:1,640159:1,640160:1,640161:1,640162:1,640163:1,640164:1,640165:1,640166:1,640167:1,640168:1,640169:1,640170:1,640171:1,640172:1,640173:1,640174:1,640175:1,640176:1,640177:1,640178:1,640179:1,640180:1,640181:1,640182:1,640183:1,640184:1,640185:1,640186:1,640187:1,640188:1,640189:1,640190:1,640191:1,640192:1,640193:1,640194:1,640195:1,640196:1,640197:1,640198:1,640199:1,640200:1,640201:1,640202:1,640203:1,640204:1,640205:1,640206:1,640207:1,640208:1,640209:1,640210:1,640211:1,640212:1,640213:1,640214:1,640215:1,640216:1,640217:1,640218:1,640219:1,640220:1,640221:1,640222:1,640223:1,640224:1,640225:1,640226:1,640227:1,640228:1,640229:1,640230:1,640231:1,640232:1,647424:1,647425:1,647426:1,647427:1,647428:1,647429:1,647430:1,647431:1,647432:1,647433:1,647434:1,647435:1,647436:1,647437:1,647438:1,647439:1,647440:1,647441:1,647442:1,647443:1,647444:1,647445:1,647446:1,647447:1,647448:1,647449:1,647450:1,647451:1,647452:1,647453:1,647454:1,647455:1,647456:1,647457:1,647458:1,647459:1,647460:1,647461:1,647462:1,647463:1,647464:1,647465:1,647466:1,647467:1,647468:1,647469:1,647470:1,647471:1,647472:1,647473:1,647474:1,647475:1,647476:1,647477:1,647478:1,647479:1,647480:1,647481:1,647482:1,647483:1,647484:1,647485:1,647486:1,647487:1,647488:1,647489:1,647490:1,647491:1,647492:1,647493:1,647494:1,647495:1,647496:1,647497:1,647498:1,647499:1,647500:1,647501:1,647502:1,647503:1,647504:1,647505:1,647506:1,647507:1,647508:1,647509:1,647510:1,647511:1,647512:1,647513:1,647514:1,647515:1,647516:1,647517:1,647518:1,647519:1,647520:1,647521:1,647522:1,647523:1,647524:1,647525:1,647526:1,647527:1,647528:1,647529:1,647530:1,647531:1,647532:1,647533:1,647534:1,647535:1,647536:1,647537:1,647538:1,647539:1,647540:1,647541:1,647542:1,647543:1,647544:1,647545:1,647546:1,647547:1,647548:1,647549:1,647550:1,647551:1,647552:1,647553:1,647554:1,647555:1,647556:1,647557:1,647558:1,647559:1,647560:1,647561:1,647562:1,647563:1,647564:1,647565:1,647566:1,647567:1,647568:1,647569:1,647570:1,647571:1,647572:1,647573:1,647574:1,647575:1,647576:1,647577:1,647578:1,647579:1,647580:1,647581:1,647582:1,647583:1,647584:1,647585:1,647586:1,647587:1,647588:1,647589:1,647590:1,647591:1,647592:1,647593:1,647594:1,647595:1,647596:1,647597:1,647598:1,647599:1,647600:1,647601:1,647602:1,647603:1,647604:1,647605:1,647606:1,647607:1,647608:1,647609:1,647610:1,647611:1,647612:1,647613:1,647614:1,647615:1,647616:1,647617:1,647618:1,647619:1,647620:1,647621:1,647622:1,647623:1,647624:1,647625:1,647626:1,647627:1,647628:1,647629:1,647630:1,647631:1,647632:1,647633:1,647634:1,647635:1,647636:1,647637:1,647638:1,647639:1,647640:1,647641:1,647642:1,647643:1,647644:1,647645:1,647646:1,647647:1,647648:1,647649:1,647650:1,647651:1,647652:1,647653:1,647654:1,647655:1,647656:1,647657:1,647658:1,647659:1,647660:1,647661:1,647662:1,647663:1,647664:1,647665:1,647666:1,647667:1,647668:1,647669:1,647670:1,647671:1,647672:1,647673:1,647674:1,647675:1,647676:1,647677:1,647678:1,647679:1,647680:1,647681:1,647682:1,647683:1,647684:1,647685:1,647686:1,647687:1,647688:1,647689:1,647690:1,647691:1,647692:1,647693:1,647694:1,647695:1,647696:1,647697:1,647698:1,647699:1,647700:1,647701:1,647702:1,647703:1,647704:1,647705:1,647706:1,647707:1,647708:1,647709:1,647710:1,647711:1,647712:1,647713:1,647714:1,647715:1,647716:1,647717:1,647718:1,647719:1,647720:1,647721:1,647722:1,647723:1,647724:1,647725:1,647726:1,647727:1,647728:1,647729:1,647730:1,647731:1,647732:1,647733:1,647734:1,647735:1,647736:1,647737:1,647738:1,647739:1,647740:1,647741:1,647742:1,647743:1,647744:1,647745:1,647746:1,647747:1,647748:1,647749:1,647750:1,647751:1,647752:1,647753:1,647754:1,647755:1,647756:1,647757:1,647758:1,647759:1,647760:1,647761:1,647762:1,647763:1,647764:1,647765:1,647766:1,647767:1,647768:1,647769:1,647770:1,647771:1,647772:1,647773:1,647774:1,647775:1,647776:1,647777:1,647778:1,647779:1,647780:1,647781:1,647782:1,647783:1,647784:1,647785:1,647786:1,647787:1,647788:1,647789:1,647790:1,647791:1,647792:1,647793:1,647794:1,647795:1,647796:1,647797:1,647798:1,647799:1,647800:1,647801:1,647802:1,647803:1,647804:1,647805:1,647806:1,647807:1,647808:1,647809:1,647810:1,647811:1,647812:1,647813:1,647814:1,647815:1,647816:1,647817:1,647818:1,647819:1,647820:1,647821:1,647822:1,647823:1,647824:1,647825:1,647826:1,647827:1,647828:1,647829:1,647830:1,647831:1,647832:1,647833:1,647834:1,647835:1,647836:1,647837:1,647838:1,647839:1,647840:1,647841:1,647842:1,647843:1,647844:1,647845:1,647846:1,647847:1,647848:1,647849:1,647850:1,647851:1,647852:1,647853:1,647854:1,647855:1,647856:1,647857:1,647858:1,647859:1,647860:1,647861:1,647862:1,647863:1,647864:1,647865:1,647866:1,647867:1,647868:1,647869:1,647870:1,647871:1,647872:1,647873:1,647874:1,647875:1,647876:1,647877:1,647878:1,647879:1,647880:1,647881:1,647882:1,647883:1,647884:1,647885:1,647886:1,647887:1,647888:1,647889:1,647890:1,647891:1,647892:1,647893:1,647894:1,647895:1,647896:1,647897:1,647898:1,647899:1,647900:1,647901:1,647902:1,647903:1,647904:1,647905:1,647906:1,647907:1,647908:1,647909:1,647910:1,647911:1,647912:1,647913:1,647914:1,647915:1,647916:1,647917:1,647918:1,647919:1,647920:1,647921:1,647922:1,647923:1,647924:1,647925:1,647926:1,647927:1,647928:1,647929:1,647930:1,647931:1,647932:1,647933:1,647934:1,647935:1,647936:1,647937:1,647938:1,647939:1,647940:1,647941:1,647942:1,647943:1,647944:1,647945:1,647946:1,647947:1,647948:1,647949:1,647950:1,647951:1,647952:1,647953:1,647954:1,647955:1,647956:1,647957:1,647958:1,647959:1,647960:1,647961:1,647962:1,647963:1,647964:1,647965:1,647966:1,647967:1,647968:1,647969:1,647970:1,647971:1,647972:1,647973:1,647974:1,647975:1,647976:1,647977:1,647978:1,647979:1,647980:1,647981:1,647982:1,647983:1,647984:1,647985:1,647986:1,647987:1,647988:1,647989:1,647990:1,647991:1,647992:1,647993:1,647994:1,647995:1,647996:1,647997:1,647998:1,647999:1,648000:1,648001:1,648002:1,648003:1,648004:1,648005:1,648006:1,648007:1,648008:1,648009:1,648010:1,648011:1,648012:1,648013:1,648014:1,648015:1,648016:1,648017:1,648018:1,648019:1,648020:1,648021:1,648022:1,648023:1,648024:1,648025:1,648026:1,648027:1,648028:1,648029:1,648030:1,648031:1,648032:1,648033:1,648034:1,648035:1,648036:1,648037:1,648038:1,648039:1,648040:1,648041:1,648042:1,648043:1,648044:1,648045:1,648046:1,648047:1,648048:1,648049:1,648050:1,648051:1,648052:1,648053:1,648054:1,648055:1,648056:1,648057:1,648058:1,648059:1,648060:1,648061:1,648062:1,648063:1,648064:1,648065:1,648066:1,648067:1,648068:1,648069:1,648070:1,648071:1,648072:1,648073:1,648074:1,648075:1,648076:1,648077:1,648078:1,648079:1,648080:1,648081:1,648082:1,648083:1,648084:1,648085:1,648086:1,648087:1,648088:1,648089:1,648090:1,648091:1,648092:1,648093:1,648094:1,648095:1,648096:1,648097:1,648098:1,648099:1,648100:1,648101:1,648102:1,648103:1,648104:1,648105:1,648106:1,648107:1,648108:1,648109:1,648110:1,648111:1,648112:1,648113:1,648114:1,648115:1,648116:1,648117:1,648118:1,648119:1,648120:1,648121:1,648122:1,648123:1,648124:1,648125:1,648126:1,648127:1,648128:1,648129:1,648130:1,648131:1,648132:1,648133:1,648134:1,648135:1,648136:1,648137:1,648138:1,648139:1,648140:1,648141:1,648142:1,648143:1,648144:1,648145:1,648146:1,648147:1,648148:1,648149:1,648150:1,648151:1,648152:1,648153:1,648154:1,648155:1,648156:1,648157:1,648158:1,648159:1,648160:1,648161:1,648162:1,648163:1,648164:1,648165:1,648166:1,648167:1,648168:1,648169:1,648170:1,648171:1,648172:1,648173:1,648174:1,648175:1,648176:1,648177:1,648178:1,648179:1,648180:1,648181:1,648182:1,648183:1,648184:1,648185:1,648186:1,648187:1,648188:1,648189:1,648190:1,648191:1,648192:1,648193:1,648194:1,648195:1,648196:1,648197:1,648198:1,648199:1,648200:1,648201:1,648202:1,648203:1,648204:1,648205:1,648206:1,648207:1,648208:1,648209:1,648210:1,648211:1,648212:1,648213:1,648214:1,648215:1,648216:1,648217:1,648218:1,648219:1,648220:1,648221:1,648222:1,648223:1,648224:1,648225:1,648226:1,648227:1,648228:1,648229:1,648230:1,648231:1,648232:1,648233:1,648234:1,648235:1,648236:1,648237:1,648238:1,648239:1,648240:1,648241:1,648242:1,648243:1,648244:1,648245:1,648246:1,648247:1,648248:1,648249:1,648250:1,648251:1,648252:1,648253:1,648254:1,648255:1,648256:1,648257:1,648258:1,648259:1,648260:1,648261:1,648262:1,648263:1,648264:1,648265:1,648266:1,648267:1,648268:1,648269:1,648270:1,648271:1,648272:1,648273:1,648274:1,648275:1,648276:1,648277:1,648278:1,648279:1,648280:1,648281:1,648282:1,648283:1,648284:1,648285:1,648286:1,648287:1,648288:1,648289:1,648290:1,648291:1,648292:1,648293:1,648294:1,648295:1,648296:1,648297:1,648298:1,648299:1,648300:1,648301:1,648302:1,648303:1,648304:1,648305:1,648306:1,648307:1,648308:1,648309:1,648310:1,648311:1,648312:1,648313:1,648314:1,648315:1,648316:1,648317:1,648318:1,648319:1,648320:1,648321:1,648322:1,648323:1,648324:1,648325:1,648326:1,648327:1,648328:1,648329:1,648330:1,648331:1,648332:1,648333:1,648334:1,648335:1,648336:1,648337:1,648338:1,648339:1,648340:1,648341:1,648342:1,648343:1,648344:1,648345:1,648346:1,648347:1,648348:1,648349:1,648350:1,648351:1,648352:1,648353:1,648354:1,648355:1,648356:1,648357:1,648358:1,648359:1,648360:1,648361:1,648362:1,648363:1,648364:1,648365:1,648366:1,648367:1,648368:1,648369:1,648370:1,648371:1,648372:1,648373:1,648374:1,648375:1,648376:1,648377:1,648378:1,648379:1,648380:1,648381:1,648382:1,648383:1,648384:1,648385:1,648386:1,648387:1,648388:1,648389:1,648390:1,648391:1,648392:1,648393:1,648394:1,648395:1,648396:1,648397:1,648398:1,648399:1,648400:1,648401:1,648402:1,648403:1,648404:1,648405:1,648406:1,648407:1,648408:1,648409:1,648410:1,648411:1,648412:1,648413:1,648414:1,648415:1,648416:1,648417:1,648418:1,648419:1,648420:1,648421:1,648422:1,648423:1,648424:1,648425:1,648426:1,648427:1,648428:1,648429:1,648430:1,648431:1,648432:1,648433:1,648434:1,648435:1,648436:1,648437:1,648438:1,648439:1,648440:1,648441:1,648442:1,648443:1,648444:1,648445:1,648446:1,648447:1,648448:1,648449:1,648450:1,648451:1,648452:1,648453:1,648454:1,648455:1,648456:1,648457:1,648458:1,648459:1,648460:1,648461:1,648462:1,648463:1,648464:1,648465:1,648466:1,648467:1,648468:1,648469:1,648470:1,648471:1,648472:1,648473:1,648474:1,648475:1,648476:1,648477:1,648478:1,648479:1,648480:1,648481:1,648482:1,648483:1,648484:1,648485:1,648486:1,648487:1,648488:1,648489:1,648490:1,648491:1,648492:1,648493:1,648494:1,648495:1,648496:1,648497:1,648498:1,648499:1,648500:1,648501:1,648502:1,648503:1,648504:1,648505:1,648506:1,648507:1,648508:1,648509:1,648510:1,648511:1,648512:1,648513:1,648514:1,648515:1,648516:1,648517:1,648518:1,648519:1,648520:1,648521:1,648522:1,648523:1,648524:1,648525:1,648526:1,648527:1,648528:1,648529:1,648530:1,648531:1,648532:1,648533:1,648534:1,648535:1,648536:1,648537:1,648538:1,648539:1,648540:1,648541:1,648542:1,648543:1,648544:1,648545:1,648546:1,648547:1,648548:1,648549:1,648550:1,648551:1,648552:1,648553:1,648554:1,648555:1,648556:1,648557:1,648558:1,648559:1,648560:1,648561:1,648562:1,648563:1,648564:1,648565:1,648566:1,648567:1,648568:1,648569:1,648570:1,648571:1,648572:1,648573:1,648574:1,648575:1,648576:1,648577:1,648578:1,648579:1,648580:1,648581:1,648582:1,648583:1,648584:1,648585:1,648586:1,648587:1,648588:1,648589:1,648590:1,648591:1,648592:1,648593:1,648594:1,648595:1,648596:1,648597:1,648598:1,648599:1,648600:1,648601:1,648602:1,648603:1,648604:1,648605:1,648606:1,648607:1,648608:1,648609:1,648610:1,648611:1,648612:1,648613:1,648614:1,648615:1,648616:1,648617:1,648618:1,648619:1,648620:1,648621:1,648622:1,648623:1,648624:1,648625:1,648626:1,648627:1,648628:1,648629:1,648630:1,648631:1,648632:1,648633:1,648634:1,648635:1,648636:1,648637:1,648638:1,648639:1,648640:1,648641:1,648642:1,648643:1,648644:1,648645:1,648646:1,648647:1,648648:1,648649:1,648650:1,648651:1,648652:1,648653:1,648654:1,648655:1,648656:1,648657:1,648658:1,648659:1,648660:1,648661:1,648662:1,648663:1,648664:1,648665:1,648666:1,648667:1,648668:1,648669:1,648670:1,648671:1,648672:1,648673:1,648674:1,648675:1,648676:1,648677:1,648678:1,648679:1,648680:1,648681:1,648682:1,648683:1,648684:1,648685:1,648686:1,648687:1,648688:1,648689:1,648690:1,648691:1,648692:1,648693:1,648694:1,648695:1,648696:1,648697:1,648698:1,648699:1,648700:1,648701:1,648702:1,648703:1,648704:1,648705:1,648706:1,648707:1,648708:1,648709:1,648710:1,648711:1,648712:1,648713:1,648714:1,648715:1,648716:1,648717:1,648718:1,648719:1,648720:1,648721:1,648722:1,648723:1,648724:1,648725:1,648726:1,648727:1,648728:1,648729:1,648730:1,648731:1,648732:1,648733:1,648734:1,648735:1,648736:1,648737:1,648738:1,648739:1,648740:1,648741:1,648742:1,648743:1,648744:1,648745:1,648746:1,648747:1,648748:1,648749:1,648750:1,648751:1,648752:1,648753:1,648754:1,648755:1,648756:1,648757:1,648758:1,648759:1,648760:1,648761:1,648762:1,648763:1,648764:1,648765:1,648766:1,648767:1,648768:1,648769:1,648770:1,648771:1,648772:1,648773:1,648774:1,648775:1,648776:1,648777:1,648778:1,648779:1,648780:1,648781:1,648782:1,648783:1,648784:1,648785:1,648786:1,648787:1,648788:1,648789:1,648790:1,648791:1,648792:1,648793:1,648794:1,648795:1,648796:1,648797:1,648798:1,648799:1,648800:1,648801:1,648802:1,648803:1,648804:1,648805:1,648806:1,648807:1,648808:1,648809:1,648810:1,648811:1,648812:1,648813:1,648814:1,648815:1,648816:1,648817:1,648818:1,648819:1,648820:1,648821:1,648822:1,648823:1,648824:1,648825:1,648826:1,648827:1,648828:1,648829:1,648830:1,648831:1,648832:1,648833:1,648834:1,648835:1,648836:1,648837:1,648838:1,648839:1,648840:1,648841:1,648842:1,648843:1,648844:1,648845:1,648846:1,648847:1,648848:1,648849:1,648850:1,648851:1,648852:1,648853:1,648854:1,648855:1,648856:1,648857:1,648858:1,648859:1,648860:1,648861:1,648862:1,648863:1,648864:1,648865:1,648866:1,648867:1,648868:1,648869:1,648870:1,648871:1,648872:1,648873:1,648874:1,648875:1,648876:1,648877:1,648878:1,648879:1,648880:1,648881:1,648882:1,648883:1,648884:1,648885:1,648886:1,648887:1,648888:1,648889:1,648890:1,648891:1,648892:1,648893:1,648894:1,648895:1,648896:1,648897:1,648898:1,648899:1,648900:1,648901:1,648902:1,648903:1,648904:1,648905:1,648906:1,648907:1,648908:1,648909:1,648910:1,648911:1,648912:1,648913:1,648914:1,648915:1,648916:1,648917:1,648918:1,648919:1,648920:1,648921:1,648922:1,648923:1,648924:1,648925:1,648926:1,648927:1,648928:1,648929:1,648930:1,648931:1,648932:1,648933:1,648934:1,648935:1,648936:1,648937:1,648938:1,648939:1,648940:1,648941:1,648942:1,648943:1,648944:1,648945:1,648946:1,648947:1,648948:1,648949:1,648950:1,648951:1,648952:1,648953:1,648954:1,648955:1,648956:1,648957:1,648958:1,648959:1,648960:1,648961:1,648962:1,648963:1,648964:1,648965:1,648966:1,648967:1,648968:1,648969:1,648970:1,648971:1,648972:1,648973:1,648974:1,648975:1,648976:1,648977:1,648978:1,648979:1,648980:1,648981:1,648982:1,648983:1,648984:1,648985:1,648986:1,648987:1,648988:1,648989:1,648990:1,648991:1,648992:1,648993:1,648994:1,648995:1,648996:1,648997:1,648998:1,648999:1,649000:1,649001:1,649002:1,649003:1,649004:1,649005:1,649006:1,649007:1,649008:1,649009:1,649010:1,649011:1,649012:1,649013:1,649014:1,649015:1,649016:1,649017:1,649018:1,649019:1,649020:1,649021:1,649022:1,649023:1,649024:1,649025:1,649026:1,649027:1,649028:1,649029:1,649030:1,649031:1,649032:1,649033:1,649034:1,649035:1,649036:1,649037:1,649038:1,649039:1,649040:1,649041:1,649042:1,649043:1,649044:1,649045:1,649046:1,649047:1,649048:1,649049:1,649050:1,649051:1,649052:1,649053:1,649054:1,649055:1,649056:1,649057:1,649058:1,649059:1,649060:1,649061:1,649062:1,649063:1,649064:1,649065:1,649066:1,649067:1,649068:1,649069:1,649070:1,649071:1,649072:1,649073:1,649074:1,649075:1,649076:1,649077:1,649078:1,649079:1,649080:1,649081:1,649082:1,649083:1,649084:1,649085:1,649086:1,649087:1,649088:1,649089:1,649090:1,649091:1,649092:1,649093:1,649094:1,649095:1,649096:1,649097:1,649098:1,649099:1,649100:1,649101:1,649102:1,649103:1,649104:1,649105:1,649106:1,649107:1,649108:1,649109:1,649110:1,649111:1,649112:1,649113:1,649114:1,649115:1,649116:1,649117:1,649118:1,649119:1,649120:1,649121:1,649122:1,649123:1,649124:1,649125:1,649126:1,649127:1,649128:1,649129:1,649130:1,649131:1,649132:1,649133:1,649134:1,649135:1,649136:1,649137:1,649138:1,649139:1,649140:1,649141:1,649142:1,649143:1,649144:1,649145:1,649146:1,649147:1,649148:1,649149:1,649150:1,649151:1,649152:1,649153:1,649154:1,649155:1,649156:1,649157:1,649158:1,649159:1,649160:1,649161:1,649162:1,649163:1,649164:1,649165:1,649166:1,649167:1,649168:1,649169:1,649170:1,649171:1,649172:1,649173:1,649174:1,649175:1,649176:1,649177:1,649178:1,649179:1,649180:1,649181:1,649182:1,649183:1,649184:1,649185:1,649186:1,649187:1,649188:1,649189:1,649190:1,649191:1,649192:1,649193:1,649194:1,649195:1,649196:1,649197:1,649198:1,649199:1,649200:1,649201:1,649202:1,649203:1,649204:1,649205:1,649206:1,649207:1,649208:1,649209:1,649210:1,649211:1,649212:1,649213:1,649214:1,649215:1,649216:1,649217:1,649218:1,649219:1,649220:1,649221:1,649222:1,649223:1,649224:1,649225:1,649226:1,649227:1,649228:1,649229:1,649230:1,649231:1,649232:1,649233:1,649234:1,649235:1,649236:1,649237:1,649238:1,649239:1,649240:1,649241:1,649242:1,649243:1,649244:1,649245:1,649246:1,649247:1,649248:1,649249:1,649250:1,649251:1,649252:1,649253:1,649254:1,649255:1,649256:1,649257:1,649258:1,649259:1,649260:1,649261:1,649262:1,649263:1,649264:1,649265:1,649266:1,649267:1,649268:1,649269:1,649270:1,649271:1,649272:1,649273:1,649274:1,649275:1,649276:1,649277:1,649278:1,649279:1,649280:1,649281:1,649282:1,649283:1,649284:1,649285:1,649286:1,649287:1,649288:1,649289:1,649290:1,649291:1,649292:1,649293:1,649294:1,649295:1,649296:1,649297:1,649298:1,649299:1,649300:1,649301:1,649302:1,649303:1,649304:1,649305:1,649306:1,649307:1,649308:1,649309:1,649310:1,649311:1,649312:1,649313:1,649314:1,649315:1,649316:1,649317:1,649318:1,649319:1,649320:1,649321:1,649322:1,649323:1,649324:1,649325:1,649326:1,649327:1,649328:1,649329:1,649330:1,649331:1,649332:1,649333:1,649334:1,649335:1,649336:1,649337:1,649338:1,649339:1,649340:1,649341:1,649342:1,649343:1,649344:1,649345:1,649346:1,649347:1,649348:1,649349:1,649350:1,649351:1,649352:1,649353:1,649354:1,649355:1,649356:1,649357:1,649358:1,649359:1,649360:1,649361:1,649362:1,649363:1,649364:1,649365:1,649366:1,649367:1,649368:1,649369:1,649370:1,649371:1,649372:1,649373:1,649374:1,649375:1,649376:1,649377:1,649378:1,649379:1,649380:1,649381:1,649382:1,649383:1,649384:1,649385:1,649386:1,649387:1,649388:1,649389:1,649390:1,649391:1,649392:1,649393:1,649394:1,649395:1,649396:1,649397:1,649398:1,649399:1,649400:1,649401:1,649402:1,649403:1,649404:1,649405:1,649406:1,649407:1,649408:1,649409:1,649410:1,649411:1,649412:1,649413:1,649414:1,649415:1,649416:1,649417:1,649418:1,649419:1,649420:1,649421:1,649422:1,649423:1,649424:1,649425:1,649426:1,649427:1,649428:1,649429:1,649430:1,649431:1,649432:1,649433:1,649434:1,649435:1,649436:1,649437:1,649438:1,649439:1,649440:1,649441:1,649442:1,649443:1,649444:1,649445:1,649446:1,649447:1,649448:1,649449:1,649450:1,649451:1,649452:1,649453:1,649454:1,649455:1,649456:1,649457:1,649458:1,649459:1,649460:1,649461:1,649462:1,649463:1,649464:1,649465:1,649466:1,649467:1,649468:1,649469:1,649470:1,649471:1");
    g_ptr_array_add(args, "8589934592");		// size of base (maximum for raw case)
    g_ptr_array_add(args, "0");					// segment size
    g_ptr_array_add(args, "4096");				// chunk size: 131072 --> 4096
    argv = (char **) g_ptr_array_free(args, FALSE);
    */

    if (argv == NULL) {
        fprintf(pipe, "%s\n", err->message);
        g_clear_error(&err);
        fclose(pipe);
        return;
    }

    /* Check argc */
    argc = g_strv_length(argv);
    images = (argc - 2) / IMAGE_ARG_COUNT;
    if (argc % IMAGE_ARG_COUNT != 2 || images < 1 || images > 2) {
        fprintf(pipe, "Incorrect argument count\n");
        fclose(pipe);
        return;
    }

    /* Get initial arguments */
    username = argv[arg++];
    if (!username[0]) {
        username = NULL;
    }
    password = argv[arg++];
    if (!password[0]) {
        password = NULL;
    }

    /* Set up disk */
    fs = g_slice_new0(struct vmnetfs);
    fs->disk = image_new(argv + arg, username, password, &err);
    if (err) {
        fprintf(pipe, "%s\n", err->message);
        goto out;
    }
    arg += IMAGE_ARG_COUNT;

    /* Set up memory */
    if (images > 1) {
        fs->memory = image_new(argv + arg, username, password, &err);
        if (err) {
            fprintf(pipe, "%s\n", err->message);
            goto out;
        }
        arg += IMAGE_ARG_COUNT;
    }

    /* Set up fuse */
    fs->fuse = _vmnetfs_fuse_new(fs, &err);
    if (err) {
        fprintf(pipe, "%s\n", err->message);
        goto out;
    }

    /* Start main loop thread */
    loop_thread = g_thread_create(glib_loop_thread, fs, TRUE, &err);
    if (err) {
        fprintf(pipe, "%s\n", err->message);
        goto out;
    }

    /* Add watch for stdin being closed */
    flags = g_io_channel_get_flags(chan);
    g_io_channel_set_flags(chan, flags | G_IO_FLAG_NONBLOCK, &err);
    if (err) {
        fprintf(pipe, "%s\n", err->message);
        g_io_channel_unref(chan);
        goto out;
    }
    g_io_add_watch(chan, G_IO_IN | G_IO_ERR | G_IO_HUP | G_IO_NVAL, read_stdin, fs);

    /* Started successfully.  Send the mountpoint back to the parent and
       run FUSE event loop until the filesystem is unmounted. */
    fprintf(pipe, "\n%s\n", fs->fuse->mountpoint);
    fflush(pipe);
    fclose(pipe);
    pipe = NULL;
    _vmnetfs_fuse_run(fs->fuse);

out:
    /* Shut down */
    if (err != NULL) {
        g_clear_error(&err);
    }
    if (pipe != NULL) {
        fclose(pipe);
    }
    if (loop_thread != NULL) {
        g_idle_add(shutdown_callback, fs);
        g_thread_join(loop_thread);
    }
    _vmnetfs_fuse_free(fs->fuse);
    image_free(fs->disk);
    image_free(fs->memory);
    g_slice_free(struct vmnetfs, fs);
    g_strfreev(argv);
    g_io_channel_unref(chan);
}

static void setsignal(int signum, void (*handler)(int))
{
    const struct sigaction sa = {
        .sa_handler = handler,
        .sa_flags = SA_RESTART,
    };

    sigaction(signum, &sa, NULL);
}

int main(int argc G_GNUC_UNUSED, char **argv G_GNUC_UNUSED)
{
    int pipes[2];
    FILE *pipe_fh;
    pid_t pid;

    setsignal(SIGINT, SIG_IGN);

    if (pipe(pipes)) {
        fprintf(stderr, "Could not create pipes\n");
        return 1;
    }

//    child(stdout);
//    return 0;

    pid = fork();
    if (pid) {
        // Parent
        char buf[256];
        int status;
        pid_t exited;

        pipe_fh = fdopen(pipes[0], "r");
        close(pipes[1]);

        // Read possible error status from child
        buf[0] = 0;
        fgets(buf, sizeof(buf), pipe_fh);
        if (ferror(pipe_fh)) {
            fprintf(stderr, "Error reading status from vmnetfs\n");
            return 1;
        }
        if (buf[0] != 0 && buf[0] != '\n') {
            fprintf(stderr, "%s", buf);
            return 1;
        }

        // See if it exited
        exited = waitpid(pid, &status, WNOHANG);
        if (exited == -1) {
            fprintf(stderr, "Error reading exit status from vmnetfs\n");
            return 1;
        } else if (exited && WIFSIGNALED(status)) {
            fprintf(stderr, "vmnetfs died on signal %d\n", WTERMSIG(status));
            return 1;
        } else if (exited) {
            fprintf(stderr, "vmnetfs died with exit status %d\n",
                    WEXITSTATUS(status));
            return 1;
        }

        // Print mountpoint and exit
        buf[0] = 0;
        fgets(buf, sizeof(buf), pipe_fh);
        if (ferror(pipe_fh)) {
            fprintf(stderr, "Error reading mountpoint from vmnetfs\n");
            return 1;
        }
        printf("%s", buf);
        return 0;

    } else {
        // Child
        pipe_fh = fdopen(pipes[1], "w");
        close(pipes[0]);

        // Ensure the grandparent doesn't block reading our output
        close(1);
        close(2);
        open("/dev/null", O_WRONLY);
        open("/dev/null", O_WRONLY);

        child(pipe_fh);
        return 0;
    }
}
